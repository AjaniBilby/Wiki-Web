<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Scanner</title>
    <script>
      function Get(url, callback){
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function(){
          if (this.readyState == 4){
            callback(this);
          }
        };
        xhttp.open("GET", url, true);
        xhttp.send();

        return xhttp;
      }

      function subLoader(dest, text) {
        var p = new DOMParser();
        var doc = p.parseFromString(text, 'text/html');

        var images = doc.getElementsByTagName('img');
        var i=0;
        while (images.length>0){
          doc.getElementsByTagName('img')[0].remove();
          i++;
        }

        var f = document.createDocumentFragment();
        while (doc.body.firstChild) {
          f.appendChild(doc.body.firstChild);
        }
        [].map.call(f.querySelectorAll('script'), function(script) {
          var scriptParent = script.parentElement || f;
          var newScript = document.createElement('script');
          if (script.src) {
            newScript.src = script.src;
          } else {
            newScript.textContent = script.textContent;
          }
          scriptParent.replaceChild(newScript, script);
         });
         dest.appendChild(f);
      }
    </script>
  </head>
  <body>
    <div id="working"></div>
    <script>
      Get('/wiki/'+location.search.substr(1), function(response){
        var working = document.getElementById('working');
        subLoader(working, response.responseText);

        var links = document.getElementById('bodyContent').getElementsByTagName('a');

        var output = {
          lines: []
        };

        for (let item of links){
          var path = item.href;

          if (path.indexOf(location.origin) === 0){
            path = path.substr( (location.origin).length );
          }

          if (path.indexOf('/wiki/') === 0 && output.lines.indexOf(path) == -1){
            output.lines.push(path.replace('/wiki/', ''));
          }
        }

        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", '/data/'+location.search.substr(1), true);
        xhttp.setRequestHeader("Content-type", 'application/json');
        xhttp.send(JSON.stringify(output));

        if (parent && finished){
          finished(output);
        }
      });
    </script>
  </body>
</html>
