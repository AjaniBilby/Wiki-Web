<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Wiki-Skimmer</title>

		<meta property="og:title" content="Wikipedia Skimmer"/>
		<meta property="og:description" content="Crawls through Wikipedia to find the degrees of seperation of two different pages"/>
		<meta property="og:type" content="website"/>

		<style>
			body{
				margin: 0px;
				margin-bottom:20px;
				background-color: white;
			}

			#menu{
				position: fixed;
				bottom: 0px;
				left: 0px;

				padding-left: 5px;

				font-family: Roboto, Calibre, Liberation Sans, Arial;

				/* height: 20px; */
				width: 100vw;

				overflow: hidden;
				background-color: white;
			}
			#menu input{
				font-family: Calibre, Liberation Sans, Arial;
			}
			#menu input[type=text]{
				width: calc(50% - 70px);
			}
			#menu input[type=submit]{
				width: 75px;
			}
			#gen-btn{
				float:right;
			}
		</style>

		<script src="logger.js"></script>
		<script src="trace.js"></script>
		<script src="./libraries/p5.min.js"></script>
		<script src="./display/vector.js"></script>
		<script src="./display/point.js"></script>
		<script src="./display/startup.js"></script>
		<script>
			var TRACE_STREAMS = 10;

			function Save(){
				var url = canvas.toDataURL('image/png');

				var a = document.createElement("a");
				a.href = url;
				a.type = 'image/png';
				a.download = title.replace(/ /g, '_')+'.png';
				document.body.appendChild(a);
				a.click();
				setTimeout(function(){
					document.body.removeChild(a);
					window.URL.revokeObjectURL(url);
				});
			}

			function Generate(start, end){
				let traceEnd = function(result){
					if(result && result.all && result.all.length>0){
						BuildPoints(result);
					}else{
						console.error("invalid result", result);
					}
				};

				Trace(start, end, traceEnd, traceEnd);
			}

			var zoom = 1;
			var zoomScale = 0.1;
			var ctrlDown = false;

			window.addEventListener('keyup', function(evt){
				if (evt.keyCode == 17){
					ctrlDown = false;
				}
			});
			window.addEventListener("keydown", function(evt){
				switch (evt.keyCode) {
					case 17: //ctrl
						ctrlDown = true;
						break;
					case 83: //s
						if (ctrlDown){
							Save();
						}
						break;
					case 187: //+ =
						zoom += zoomScale;
						break;
					case 189: //- _
						zoom -= zoomScale;
						if (zoom <= 0){
							zoom = zoomScale;
						}
						break;
				}

				var percent = zoom;
				if (zoom < 0){
					percent = 1/(Math.abs(zoom)+1);
				}

				document.body.getElementsByTagName('canvas')[0].style.zoom = percent;
			});
		</script>
	</head>
	<body>

		<form id="menu">
			<div>
				<input id="start" type="text" value="cat" required>
				to
				<input id="end" type="text" value="dog" required>
				<input type="submit" value="Generate">
			</div>
			<div style="padding-top: 5px;">
				<label>Trace Streams: </label><input id="trace_streams" value="10" min="1" type="number">
			</div>
		</form>

		<script>
			document.getElementById('menu').onsubmit = function(evt){
				evt.preventDefault();

				var start = document.getElementById('start').value.replace(/ /g, '_');
				var end = document.getElementById('end').value.replace(/ /g, '_');
				document.body.getElementsByTagName('canvas')[0].style.zoom = 1;

				new logger.message('<b>Starting...</b>');

				let startCheck = 0;
				let endCheck = 0;

				function AttemptStart(){
					// One of the items is still checking
					if (startCheck == 0 || endCheck == 0){
						return;
					}

					if (startCheck == -1){
						new logger.message('<b>Invalid start point</b>');
						return;
					}
					if (endCheck == -1){
						new logger.message('<b>Invalid end point</b>');
						return;
					}

					// Both points are valid so start genereting result
					Generate(start, end);
				}

				// Check the start and end point are valid
				Get(start, (refs)=>{
					startCheck = (refs == null || refs.length < 1) ? -1 : 1;
					AttemptStart();
				});
				Get(end, (refs)=>{
					endCheck = (refs == null || refs.length < 1) ? -1 : 1;
					AttemptStart();
				});

				return false;
			};

			document.getElementById('trace_streams').onchange = function(evt){
				let num = Number(this.value);
				if (num > 1 && !isNaN(num)){
					TRACE_STREAMS = num;
				}
			}
		</script>
	</body>
</html>
