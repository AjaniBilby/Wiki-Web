<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Path Finder</title>
    <script>
      function Get(url, callback){
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function(){
          if (this.readyState == 4){
            callback(this);
          }
        };
        xhttp.open("GET", url, true);
        xhttp.send();

        return xhttp;
      }
      function Trace(start, target){
        return new Promise(function(resolve, reject) {
          var paths = {};
          var loop = {
            search: [start],
            completed: [],
            next: []
          };
          loop.run = function(){
            for (let i=0; i<loop.search.length; i++){
              loop.completed[i] = false;
              Get('/data/'+loop.search[i], function(response){
                if (response.status == 200){

                  response.responseText = response.responseText.replace('\r\n', '\n', 'g');

                  var items = response.responseText.split('\r\n');

                  for (let item of items){
                    if (typeof(item) == "string" && item.length > 0 && loop.next.indexOf(item) == -1 && searched.indexOf(item) == -1){
                      loop.next.push(item);

                      if (paths[loop.search[i]] === undefined){
                        paths[loop.search[i]] = [];
                      }
                      paths[loop.search[i]].push(item);
                    }
                  }

                  if (searched.indexOf(loop.search[i]) == -1){
                    searched.push(loop.search[i]);
                  }
                }else{
                  paths[loop.search[i]] = null;

                  if (searched.indexOf(loop.search[i]) == -1){
                    searched.push(loop.search[i]);
                  }
                }

                loop.completed[i] = true;

                attemptEnd();
              });
            }
          };
          var searched = [];

          var attemptEnd = function(){
            if (loop.completed.indexOf(false) != -1){
              return;
            }

            if (loop.next.length > 0){
              loop.search = loop.next;
              loop.completed = [];
              loop.next = [];

              loop.run();
              return;
            }

            if (searched.indexOf(target) === -1){
              reject(paths);
            }else{
              resolve(paths);
            }
          };

          loop.run();
        });
      }
    </script>
  </head>
  <body>
    <code id="result"></code>

    <script>
      var queries = {};
      (function(){
        var qs = location.search.substr(1);
        var qss = qs.split('&');
        for (let item of qss){
          item = item.split('=');

          if (item[1] === undefined){
            item[1] = true;
          }else if (item[1] == "true"){
            item[1] = true;
          }else if (item[1] == "false"){
            item[1] = false;
          }

          queries[item[0]] = item[1];
        }
      })();

      (function(){
        if (queries.start && queries.target){
          Trace(queries.start, queries.target).then(function(path){
            var result = {
              success: true,
              path: path
            };
            result = JSON.stringify(result);
            document.getElementById('result').innerHTML = result;
          }).catch(function(path){
            var result = {
              success: false,
              path: path
            };
            result = JSON.stringify(result, 2, null);
            document.getElementById('result').innerHTML = result;
          });
        }else{
          document.write('Bad Path');
        }
      })();
    </script>

  </body>
</html>
